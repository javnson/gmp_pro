# CTL 控制模板库 - 说明文档

## 简介

CTL (Control Template Library) 是一个专为数字控制系统设计的模块化、可重用的C语言代码库。它提供了一系列经过验证的、独立的控制模块，旨在简化和加速嵌入式控制应用的开发。

这些模块涵盖了从基础的信号处理到高级控制策略的各种常用功能，并且被设计为易于集成到各种微控制器（MCU）平台。

## 模块概览

本库包含以下几类核心模块，每一类都针对特定的控制需求：

- **基础模块 (Basic)**: 提供信号处理和生成的基础功能，是构建更复杂系统的基石。
- **连续控制器 (Continuous Controller)**: 包含基于连续域（S域）理论设计的经典控制器，如PID，并将其离散化以在数字系统中实现。
- **离散控制器 (Discrete Controller)**: 提供直接在离散域（Z域）中设计的控制器和滤波器，是数字控制的核心。
- **基于幅值的控制 (Magnitude-based Control)**: 包含决策逻辑直接依赖于信号幅值的非线性控制器，通常响应速度极快。
- **保护模块 (Protection)**: 用于实现系统安全保护，如过流、过压及电能质量异常的监测与响应。
- **高级控制器 (Advanced Controller)**: 实现更复杂的现代控制算法，如自适应控制等。

## 开发人员指南：API命名约定

为了保持代码的一致性和可读性，本库中的所有函数均遵循统一的命名规则。这有助于开发者快速理解函数的功能和使用场景。

**基本结构:**

```
ctl_<action>_<target_object>_via_<data_source>_<configurations>
```

**各部分说明:**

- **`ctl_`**: 所有库函数使用的固定前缀。
- **`<action>`**: 描述函数的主要操作。
  - `init`, `setup`: 用于模块的初始化过程，通常只在启动时调用一次。
  - `step`: 用于执行模块在每个控制周期的计算，是实时循环（如ISR）中的核心函数。
  - `get`, `set`: 用于获取或设置模块的内部状态或参数。
  - `input`, `output`: 用于标记在控制流程的特定阶段（输入/输出）调用的函数。
- **`<target_object>`**: 指明函数操作的目标模块，例如 `pid`, `ramp`, `sogi` 等。
- **`_via_<data_source>`**: (可选) 用于指定函数执行所依赖的数据来源或方式，例如 `_via_amp_freq` 表示通过幅值和频率参数进行设置。
- **`_<configurations>`**: (可选) 用于区分同一模块的不同实现或配置，例如 `_par` 表示并联拓扑，`_2` 表示第二种实现方式。

**示例:**

- `ctl_init_pid`, `ctl_set_pid_limit`: 来自 `pid.h` 的函数。
- `ctl_init_ramp_generator_via_freq`, `ctl_step_ramp_generator`: 来自 `signal_generator.h` 的函数。

## 1. 基础模块 (Basic)

`basic`子模块提供了一系列在控制系统中不可或缺的基础功能。

- **1.1 分频器 (`divider.h`)**: 实现了一个基于计数器的分频器，用于从高频事件中生成低频触发信号，适合在快速中断中执行慢速任务。
- **1.2 饱和/限幅模块 (`saturation.h`)**: 提供标准的饱和（限幅）功能，可将信号强制限制在指定的上下限之间，并支持为正负信号设置不同限制范围的双极性饱和模式。
- **1.3 斜率限制器 (`slope_limiter.h`)**: 也称为变化率限制器，用于约束信号的变化速率，防止输出发生突变，常用于实现平滑的设定值过渡。

## 2. 连续控制器 (Continuous Controller)

本模块包含基于连续时间理论设计的经典控制器。

- **2.1 连续形式PID控制器 (`continuous_pid.h`)**: 提供了基于连续PID公式离散化后的标准PID和抗积分饱和（Anti-Windup）PID控制器，支持串联和并联两种形式。
- **2.2 跟踪PID控制器 (`track_pid.h`)**: 这是一个复合控制器，它将分频器、斜率限制器和连续PID控制器相结合，专为需要平滑设定值跟踪的场景设计。
- **2.3 二阶广义积分器 (`sogi.h`)**: 实现了一个SOGI（Second-Order Generalized Integrator），它是一种频率自适应滤波器，能够从输入信号中生成同相和90°相移（正交）的正弦信号，是锁相环（PLL）等应用的核心。
- **2.4 S域传递函数 (`s_function.h`)**: 提供了一个通用的二阶S域传递函数模块。用户可以通过直观地指定S平面上的极点和零点频率来快速设计和实现一个控制器或滤波器。

## 3. 离散控制器 (Discrete Controller)

本模块提供了直接在离散时间域（Z域）中设计的丰富多样的控制器、滤波器和信号发生器。

- **3.1 离散PID与跟踪PID (`discrete_pid.h`, `track_discrete_pid.h`)**: 提供了标准的增量式离散PID控制器，以及集成了斜率生成和分频功能的复合跟踪PID控制器。
- **3.2 谐振与比例谐振控制器 (`proportional_resonant.h`)**: 实现了多种谐振控制器（R, PR, QR, QPR），它们能在特定谐振频率提供极高增益，是实现交流信号无静差跟踪的关键，尤其适用于并网逆变器等电力电子应用。
- **3.3 离散滤波器与补偿器 (`discrete_filter.h`, `pole_zero.h`, `lead_lag.h`)**: 提供了丰富的线性滤波器库，包括一阶/二阶IIR滤波器、可配置的通用极零点补偿器（1P1Z, 2P2Z, 3P3Z）以及经典的超前/滞后补偿器，用于系统校正和噪声抑制。
- **3.4 通用Z域传递函数 (`z_function.h`)**: 这是一个通用的IIR滤波器模块，用户可以通过直接提供Z域传递函数的分子和分母系数，来实现任意的线性时不变控制器或滤波器。
- **3.5 离散SOGI (`discrete_sogi.h`)**: 离散形式的二阶广义积分器，功能与连续版本类似，是数字锁相环（PLL）和高级信号分析的基础。
- **3.6 信号发生器 (`signal_generator.h`)**: 包含用于仿真、测试和系统激励的常用信号发生器，如基于相量旋转法的高效正/余弦波发生器和斜坡信号（锯齿波）发生器。

## 4. 基于幅值的控制 (Magnitude-based Control)

本模块包含非线性控制器，其控制决策直接基于信号的当前幅值，通常具有非常快的动态响应。

- **4.1 迟滞控制器 (`hysteresis_controller.h`)**: 也称为“邦-邦”控制（Bang-Bang），其输出仅在0和1两个状态间切换。当输入信号穿越预设的迟滞带边界时，输出状态翻转。因其响应极快，常用于电流环控制。
- **4.2 滑模控制器 (`smc.h`)**: 实现了一种滑模控制器（Sliding Mode Controller），这是一种鲁棒性极强的非线性控制方法，能有效应对系统参数不确定性和外部扰动。

## 5. 保护模块 (Protection)

此模块提供了确保系统安全运行的关键组件。

- **5.1 通用边界保护监视器 (`protection.h`)**: 一个可配置的保护系统，能同时监视多个变量，检查它们是否超出了各自的预设安全范围。
- **5.2 三段式反时限过流保护 (`itoc_protection.h`)**: 模拟了工业断路器的行为，提供三段式过流保护：针对极大电流的**瞬时**脱扣，针对中等故障电流的**短延时**脱扣，以及针对轻微过载的**长延时**脱扣。
- **5.3 电压暂降/暂升检测器 (`sag_swell.h`)**: 专用于检测电能质量问题。它内部集成了一个SOGI来精确计算输入电压的基波幅值，并根据其是否在规定时间内持续低于或高于标称值来判断是否发生电压暂降或暂升事件。

## 6. 高级控制器 (Advanced Controller)

本模块提供了更复杂的控制算法和工具，用于实现自适应控制等高级功能。

- **6.1 查表与插值 (`surf_search.h`)**: 提供了实现复杂非线性函数所需的基础工具――查找表（LUT）。它支持一维和二维（均匀/非均匀网格）的查表，并内置了高效的搜索（二分法）和插值（线性/双线性）算法，是实现高性能非线性控制的基础。
- **6.2 模糊PID控制器 (`fuzzy_pid.h`)**: 实现了一个模糊自整定PID控制器。它利用**误差(E)**和**误差变化率(EC)**作为输入，通过查询预设的二维查找表（即模糊规则）来实时调整PID的 `Kp`, `Ki`, `Kd` 参数，从而让控制器能够动态适应系统特性的变化。

## 结论

CTL控制模板库为您提供了一套全面、模块化且易于使用的工具，旨在帮助您快速构建稳定、高效的数字控制系统。希望这份文档能帮助您更好地理解和使用本库。