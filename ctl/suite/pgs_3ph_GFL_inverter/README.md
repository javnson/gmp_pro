# 跟网型变流器 (GFL Inverter) 项目说明文档

## 项目概述

本项目实现了一个简单的跟网型变流器 (Grid Following Inverter)，基于 GMP 库开发。该变流器支持并网运行，可通过 `BUILD_LEVEL` 进行增量化逐步调试，适用于多种硬件平台。

## 项目结构

```
pgs_3ph_GFL_inverter/
├── implement/          # 实现代码
│   ├── common/         # 所有平台公用代码
│   │   ├── ctl_main.c  # 核心控制逻辑
│   │   ├── ctl_main.h  # 控制逻辑头文件
│   │   ├── user_main.c # 用户主循环
│   │   └── user_main.h # 用户主循环头文件
│   ├── f280039c_iris_node/ # TI F280039C平台
│   ├── f280049c/       # TI F280049C平台
│   ├── simulate/       # 仿真平台
│   └── stm32g431/      # STM32G431平台
├── project/            # 工程结构
│   ├── f280039c_Iris_node/ # TI F280039C工程
│   └── f280049c/       # TI F280049C工程
└── README.md           # 项目说明文档
```

## 核心组件

### 1. 控制核心 (implement/common/ctl_main.c)

#### 主要对象
- **CiA402状态机**：实现变流器的状态管理
- **调制器**：支持SPWM和NPC调制
- **控制器主体**：
  - `gfl_pq_ctrl_t`：PQ功率控制器
  - `gfl_inv_ctrl_t`：逆变器控制器
- **PLL观测器**：用于电网同步
- **ADC校准器**：用于ADC偏移校准

#### 初始化流程
1. 禁用输出
2. 初始化GFL逆变器参数
3. 初始化调制器
4. 初始化PQ功率控制器
5. 根据`BUILD_LEVEL`配置不同的控制模式
6. 初始化CiA402状态机
7. 初始化ADC校准器

### 2. 用户主循环 (implement/common/user_main.c)

#### 主要功能
- **AT命令处理**：提供PWMON、PWROFF、RST等命令
- **任务调度**：使用GMP调度器管理多个任务
  - `tsk_blink`：LED闪烁任务
  - `tsk_at_device`：AT命令处理任务
  - `tsk_monitor`：监控数据发送任务

### 3. 平台特有代码

每个平台目录包含：
- `ctrl_settings.h`：控制参数设置
- `xplt.config.h`：平台配置
- `xplt.ctl_interface.h`：控制接口
- `xplt.peripheral.c/h`：外设驱动

## BUILD_LEVEL 增量化调试

项目使用 `BUILD_LEVEL` 宏定义实现增量化逐步调试，从简单到复杂的控制模式：

### BUILD_LEVEL 1: 电压开环控制
- 逆变器工作在开环模式
- 设置固定的输出电压幅值和频率

### BUILD_LEVEL 2: 基本电流闭环控制
- 逆变器工作在电流闭环模式
- 设置固定的电流参考值

### BUILD_LEVEL 3: 并网电流闭环控制
- 逆变器工作在电流闭环模式
- 启用PLL进行电网同步
- 配置为并网模式
- 调整CiA402状态机切换延迟，确保成功并网

### BUILD_LEVEL 4: 高级电流闭环控制
- 逆变器工作在电流闭环模式
- 启用前馈控制
- 启用解耦控制
- 启用有源阻尼
- 启用超前补偿器
- 设置较大的电流参考值

## 状态机与操作流程

### CiA402状态机

项目使用CiA402标准状态机管理变流器的运行状态：

1. **初始状态**：设备通电后进入
2. **就绪状态**：完成初始化后进入
3. **运行状态**：接收到使能命令后进入
4. **故障状态**：发生故障时进入

### 操作流程

1. **启动流程**：
   - 设备通电，初始化完成
   - 发送 `PWMON` 命令使能操作
   - 状态机从 "Ready to Switch On" 切换到 "Enable Operation"
   - 逆变器开始运行

2. **停止流程**：
   - 发送 `PWROFF` 命令
   - 状态机切换到 "Switched Off"
   - 逆变器停止运行

3. **故障处理**：
   - 发生故障时进入 "Fault" 状态
   - 发送 `RST` 命令重置故障
   - 状态机恢复到 "Ready to Switch On"

## 硬件平台支持

项目支持以下硬件平台：

1. **TI F280039C Iris Node**
2. **TI F280049C**
3. **STM32G431**
4. **仿真平台**

## 如何使用

### 1. 选择平台

根据目标硬件选择对应的平台目录，例如：
- 对于TI F280039C，使用 `implement/f280039c_iris_node/`
- 对于仿真环境，使用 `implement/simulate/`

### 2. 配置 BUILD_LEVEL

在编译前，根据调试需要设置 `BUILD_LEVEL` 宏定义：

```c
#define BUILD_LEVEL 1  // 从电压开环开始
```

### 3. 编译与烧录

使用对应平台的工程文件进行编译和烧录：
- 对于TI平台，使用CCS工程
- 对于STM32平台，使用Keil工程
- 对于仿真平台，使用对应的仿真工具

### 4. 调试步骤

按照以下步骤进行增量化调试：

1. **BUILD_LEVEL 1**：验证电压开环输出
   - 检查PWM波形是否正确
   - 检查并确认电压传感器和电流传感器工作正常
   - 测量输出电压幅值和频率
   
2. **BUILD_LEVEL 2**：验证电流闭环控制
   - 接入负载
   - 检查电流是否跟踪参考值
   - 检查PLL是否可以正常工作
   
3. **BUILD_LEVEL 3**：验证并网功能
   - 连接到电网
   - 检查PLL是否锁定
   - 验证并网电流波形

4. **BUILD_LEVEL 4**：验证高级控制功能
   - 检查系统稳定性
   - 测试动态响应
   - 验证各种补偿器的效果

## 监控与调试

### AT命令

| 命令    | 功能                  |
|---------|-----------------------|
| PWMON   | 使能控制器操作        |
| PWROFF  | 关闭控制器            |
| RST     | 重置系统故障          |

### 监控数据

项目通过 `tsk_monitor` 任务定期发送监控数据，可通过串口查看系统状态。

## 注意事项

1. **并网安全**：在进行并网测试时，确保符合当地电网规范，建议在专业人员指导下进行。

2. **硬件保护**：确保硬件电路具有过压、过流、过热等保护措施。

3. **参数调整**：根据实际硬件参数调整 `gfl_init` 结构体中的参数，特别是电网滤波器参数。

4. **调试顺序**：严格按照 `BUILD_LEVEL` 的顺序进行调试，确保每个级别都工作正常后再进入下一级别。

## 故障排查

### 常见问题

1. **无法并网**：
   - 检查PLL是否锁定
   - 验证电网电压和频率是否在正常范围
   - 检查CiA402状态机切换延迟设置

2. **电流波形异常**：
   - 检查电流传感器校准
   - 调整电流控制器参数
   - 验证调制器配置

3. **系统不稳定**：
   - 检查控制器参数是否合适
   - 验证采样频率和控制频率
   - 检查硬件电路是否存在谐振

## 总结

本项目提供了一个基于GMP库的跟网型变流器实现，通过模块化设计和增量化调试方法，方便用户理解和开发变流器控制算法。项目支持多种硬件平台，可根据实际需求进行扩展和修改。
